<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        <meta name="author" content="Geonovum">
        <link rel="canonical" href="https://apitestdocs.geonovum.nl/setup/platform/">
        <link rel="shortcut icon" href="../../img/favicon.ico">
        <title>Platform setup - Geonovum OGC API Testbed</title>
        <link href="../../css/bootstrap.min.css" rel="stylesheet">
        <link href="../../css/font-awesome.min.css" rel="stylesheet">
        <link href="../../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css">

        <script src="../../js/jquery-1.10.2.min.js" defer></script>
        <script src="../../js/bootstrap.min.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="../..">Geonovum OGC API Testbed</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-toggle="collapse" data-target="#navbar-collapse">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="navitem">
                                <a href="../.." class="nav-link">Home</a>
                            </li>
                            <li class="navitem">
                                <a href="../../howto/" class="nav-link">Howto</a>
                            </li>
                            <li class="navitem">
                                <a href="../" class="nav-link">Setup</a>
                            </li>
                            <li class="navitem">
                                <a href="../../findings/" class="nav-link">Results</a>
                            </li>
                            <li class="navitem">
                                <a href="https://github.com/Geonovum/ogc-api-testbed" class="nav-link">Code</a>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ml-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li class="nav-item">
                                <a href="https://github.com/Geonovum/ogc-api-testbed/edit/master/docs/setup/platform.md" class="nav-link"><i class="fa fa-github"></i> Edit on GitHub</a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-light navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-toggle="collapse" data-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-secondary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-level="1"><a href="#platform-setup" class="nav-link">Platform setup</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-level="2"><a href="#design-principles" class="nav-link">Design Principles</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#components" class="nav-link">Components</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#production-and-sandbox-instance" class="nav-link">Production and Sandbox Instance</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#selective-redeploy" class="nav-link">Selective Redeploy</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#security" class="nav-link">Security</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#steps-and-workflows" class="nav-link">Steps and Workflows</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h1 id="platform-setup">Platform setup</h1>
<p>The project repository contains contains components to bootstrap, configure and maintain a remote
deployment of an OGC API web-service stack using modern "DevOps" tooling.</p>
<h2 id="design-principles">Design Principles</h2>
<p>The main design principles are:</p>
<ul>
<li>starting point is an empty VPS/VM with Ubuntu and root (key) access</li>
<li>any action on the server/VM host is performed from a client host</li>
<li>i.e. no direct access/login to/on the server/VM is required, only for problem solving</li>
<li>remote actions can be performed manually or triggered by GitHub Workflows</li>
<li>all credentials (passwords, SSH-keys, etc) are secured </li>
<li>two operational stack instances 1) production, <em>"Stable"</em> and 2) playground, <em>"Sandbox"</em></li>
</ul>
<h2 id="components">Components</h2>
<p>The components used at the lowest level are:</p>
<ul>
<li><a href="https://www.docker.com/">Docker</a> <em>"...OS-level virtualization to deliver software in packages called containers..."</em> (<a href="https://en.wikipedia.org/wiki/Docker_(software)">Wikipedia</a>)</li>
<li><a href="https://docs.docker.com/compose">Docker Compose</a> <em>"...a tool for defining and running multi-container Docker applications..."</em></li>
<li><a href="https://www.ansible.com/">Ansible</a> <em>"...an open-source software provisioning tool"</em> (<a href="https://en.wikipedia.org/wiki/Ansible_(software)">Wikipedia</a>)</li>
<li><a href="https://docs.github.com/en/actions">GitHub Actions/Workflows</a> <em>"...Automate, customize, and execute software development workflows in a GitHub repository..."</em></li>
</ul>
<p>The Docker-components are used to run the operational stack, i.e. the OGC API web-services and supporting services like for monitoring. 
Ansible is used to provision both the server OS-software
and the operational stack. Ansible is executed on a local client/desktop system to invoke operations on a remote server/VM.
These operations are bundled in so called Ansible Playbooks, YAML files that describe a desired server state.
GitHub Actions are used to construct Workflows. These Actions will invoke these Ansible Playbooks, effectively configuring
and provisioning the operational stack on a remote server/VM. </p>
<p>Security is guaranteed by the use of <a href="https://docs.ansible.com/ansible/latest/user_guide/vault.html">Ansible-Vault</a> 
and <a href="https://docs.github.com/en/actions/reference/encrypted-secrets">GitHub Encrypted Secrets</a>.</p>
<p>The operational stack has the following components:</p>
<ul>
<li><a href="https://traefik.io/">Traefik</a> a frontend proxy/load-balancer and SSL (HTTPS) endpoint.</li>
<li><a href="https://pygeoapi.io/">pygeoapi</a> a Python server implementation of the OGC API suite of standards.</li>
<li><a href="http://geoserver.org/">GeoServer</a> a Java server implementation of the OGC API suite of standards.</li>
<li><a href="https://interactive-instruments.github.io/ldproxy/">ldproxy</a> a Java server implementation of the OGC API suite of standards.</li>
<li><a href="https://www.qgis.org/">QGIS Server</a> - server component of QGIS with OGC OAFeat support.</li>
<li><a href="https://postgis.net">PostgreSQL/PostGIS</a> - geospatial database</li>
</ul>
<p>For administration, documentation and monitoring the following components are used:</p>
<ul>
<li><a href="https://www.mkdocs.org/">mkdocs</a> for live documentation and landing pages</li>
<li><a href="https://www.pgadmin.org/">PGAdmin</a> - visual PostgreSQL manager  </li>
<li><a href="https://geohealthcheck.org">GeoHealthCheck</a> to monitor the availability, compliance and QoS of OGC web services</li>
<li><a href="https://www.portainer.io/">Portainer</a> visual Docker monitor and manager</li>
</ul>
<h2 id="production-and-sandbox-instance">Production and Sandbox Instance</h2>
<p>Two separate server/CM-instances are managed to provide stable/production and 
sandbox/playground environments. As to control changes these instances are mapped to two GitHub repositories:</p>
<ul>
<li>https://github.com/Geonovum/ogc-api-testbed for the stable/production instance, nicknamed <strong>Stable</strong></li>
<li>https://github.com/Geonovum/ogc-api-sandbox the playground instance, nicknamed <strong>Sandbox</strong></li>
</ul>
<p>The <strong>Stable</strong> repo is a so called <a href="https://docs.github.com/en/github/creating-cloning-and-archiving-repositories/creating-a-repository-on-github/creating-a-template-repository">GitHub Template repo</a> 
from which the <strong>Sandbox</strong> is cloned.</p>
<p><em>NB initally <a href="https://docs.github.com/en/github/administering-a-repository/defining-the-mergeability-of-pull-requests/about-protected-branches">GitHub Protected Branches</a> were considered, but</em>
<em>it felt that those would be less transparent and even confusing for selective access and chances of mistakes.</em></p>
<h2 id="selective-redeploy">Selective Redeploy</h2>
<p>When changes are pushed to the repo, only the affected services are redeployed.
This is effected by a combination of GitHub Actions and Ansible Playbooks as follows:</p>
<ul>
<li>each Service has a dedicated GitHub Action "deploy" file, e.g. <a href=".github/workflows/deploy.pygeoapi.yml">deploy.pygeoapi.yml</a></li>
<li>the GitHub Action "deploy" file contains a trigger for a <code>push</code> with a <code>paths</code> constraint, in this example:</li>
</ul>
<pre><code>    on:
      push:
        paths:
          - 'services/pygeoapi/**'
</code></pre>
<ul>
<li>the GH Action then calls the Ansible Playbook <a href="ansible/deploy.yml">deploy.yml</a> with a <code>--tags</code> option related to the Service, e.g. <code>--tags pygeoapi</code></li>
<li>the <a href="ansible/deploy.yml">deploy.yml</a> will always update the GH repo on the server VM via the <code>pre_tasks</code></li>
<li>the Ansible task indicated by the <code>tags</code> is then executed</li>
</ul>
<h2 id="security">Security</h2>
<p>Maintaining a public repository and providing secured access to services can be a challenge.
Complex solutions exist in the Docker space using Docker Secrets, <code>/etcd</code> service etc
We tried to keep it simpler, using <a href="https://docs.ansible.com/ansible/latest/user_guide/vault.html">Ansible Vault</a> 
and <a href="https://dev.to/n3wt0n/how-secrets-work-in-github-and-how-to-manage-them-p4o">GitHub Secrets</a> are the two main
mechanisms used for bootstrap and deploy.</p>
<p>The <a href="https://github.com/Geonovum/ogc-api-testbed/blob/main/ansible/bootstrap.yml">bootstrap.yml</a> also applies various Linux hardening components like
IP-blacklisting on multiple login attempt, key-only logine etc.</p>
<h2 id="steps-and-workflows">Steps and Workflows</h2>
<p>These can be used to setup a running server from zero.</p>
<h3 id="prerequisites">Prerequisites</h3>
<p>Step 0, this is what you need to have available first.</p>
<h4 id="access-to-a-servervm">Access to a server/VM</h4>
<p>This implies acquiring a server/VM instance from a hosting provider.
Main requirements are that server/VM runs an LTS Ubuntu (20.4 or better) and that SSL-keys are available for root access 
(or an admin user account with sudo-rights).</p>
<p>Login there first and copy your SSh public key (<code>id_rsa.pub</code> usually) key to <code>/root/.ssh/authorized_keys</code></p>
<h4 id="python-3-and-ansible">Python 3 and Ansible</h4>
<p>You need a Python 3 installation and then it is a matter of running</p>
<p><code>pip install ansible</code>.</p>
<p>NB best is to use a Python Virtual Environment.</p>
<h3 id="step-1-clone-template-repo">Step 1 - Clone template repo</h3>
<p>Clone from the template repo: https://github.com/Geonovum/ogc-api-testbed.git.
See <a href="https://docs.github.com/en/github/creating-cloning-and-archiving-repositories/creating-a-repository-on-github/creating-a-repository-from-a-template">how to do this</a>.</p>
<h3 id="step-2-adapt-variables-and-credentials">Step 2 - Adapt variables and credentials</h3>
<p>Adapt the files under <code>git/ansible/vars</code>, following the README there.</p>
<p>Adapt the inventory file under <code>git/ansible/hosts</code>, following the README there.</p>
<h3 id="step-3-bootstrap-the-servervm">Step 3 - Bootstrap the server/VM</h3>
<p>"Bootstrap" here implies the complete provisioning of a remote server/VM that runs the operational service stack.
This is a one-time manual action, but can be executed at any time as Ansible actions are idempotent.
By its nature, Ansible tasks will only change the system if there is something to do.</p>
<p>Startpoint is a fresh Ubuntu-server or VM with root access via SSH-keys (no passwords).
The Ansible playbook <a href="ansible/bootstrap.yml">bootstrap.yml</a> installs the neccessary software, and hardens
the server security, e.g. using <a href="https://www.fail2ban.org/">fail2ban</a>.
In this step Docker and Docker Compose are installed and a Linux <a href="https://en.wikipedia.org/wiki/Systemd">systemd</a> service is run
that automatically starts/stops the operational stack, also on reboots.
The software for the operational stack, i.e. from this repo, is cloned on the server as well.</p>
<h3 id="step-3-maintain-the-servervm">Step 3 - Maintain the server/VM</h3>
<p>This step is the daily operational maintenance. 
The basic substeps are:</p>
<ul>
<li>make a change, e.g. add a data Collection to an OGC API OAFeat service</li>
<li>commit/push the change to GitHub</li>
<li>watch the triggered GitHub Actions, check for any errors</li>
<li>observe changes via website</li>
</ul></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
                <p>&copy; 2021 Geonovum</p>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>
            var base_url = "../..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../../js/base.js" defer></script>
        <script src="../../search/main.js" defer></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
                <p>From here you can search these documents. Enter your search terms below.</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No results found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
